<html>
<head>
<script type="text/javascript" src="blockly_uncompressed.js"></script>
<script type="text/javascript" src="blocks/agocontrol.js"></script>
<script type="text/javascript" src="blocks/colour.js"></script>
<script type="text/javascript" src="blocks/lists.js"></script>
<script type="text/javascript" src="blocks/logic.js"></script>
<script type="text/javascript" src="blocks/loops.js"></script>
<script type="text/javascript" src="blocks/math.js"></script>
<script type="text/javascript" src="blocks/procedures.js"></script>
<script type="text/javascript" src="blocks/text.js"></script>
<script type="text/javascript" src="blocks/variables.js"></script>
<script type="text/javascript" src="blocks/common.js"></script>
<script type="text/javascript" src="blocks/datetime.js"></script>
<script type="text/javascript" src="generators/lua.js"></script>
<script type="text/javascript" src="generators/lua/agocontrol.js"></script>
<script type="text/javascript" src="generators/lua/colour.js"></script>
<script type="text/javascript" src="generators/lua/lists.js"></script>
<script type="text/javascript" src="generators/lua/logic.js"></script>
<script type="text/javascript" src="generators/lua/loops.js"></script>
<script type="text/javascript" src="generators/lua/math.js"></script>
<script type="text/javascript" src="generators/lua/procedures.js"></script>
<script type="text/javascript" src="generators/lua/text.js"></script>
<script type="text/javascript" src="generators/lua/variables.js"></script>
<script type="text/javascript" src="msg/js/en.js"></script>
<script type="text/javascript" src="yaml.min.js"></script>
<script type="text/javascript" src="libphonenumber.js"></script>

</head>
<body>

<xml style="display: none" id="toolbox">
        <category name="Logic">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_boolean"></block>
            <block type="logic_ternary"></block>
        </category>
        <category name="Loops">
            <block type="controls_repeat"></block>
            <block type="controls_whileUntil"></block>
            <block type="controls_for">
                <value name="FROM">
                    <block type="math_number">
                        <title name="NUM">1</title>
                    </block>
                </value>
                <value name="TO">
                    <block type="math_number">
                        <title name="NUM">10</title>
                    </block>
                </value>
                <value name="BY">
                    <block type="math_number">
                        <title name="NUM">1</title>
                    </block>
                </value>
            </block>
            <block type="controls_forEach"></block>
            <block type="controls_flow_statements"></block>
        </category>
        <category name="Math">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
            <block type="agocontrol_range">
                <value name="MIN">
                    <block type="math_number">
                        <title name="NUM">0</title>
                    </block>
                </value>
                <value name="PROP">
                    <block type="agocontrol_eventProperty"></block>
                </value>
                <value name="MAX">
                    <block type="math_number">
                        <title name="NUM">100</title>
                    </block>
                </value>
            </block>
            <block type="math_number_property"></block>
            <block type="math_change">
                <value name="DELTA">
                    <block type="math_number">
                        <title name="NUM">1</title>
                    </block>
                </value>
            </block>
            <block type="math_round"></block>
            <block type="math_on_list"></block>
            <block type="math_constrain">
                <value name="LOW">
                    <block type="math_number">
                        <title name="NUM">1</title>
                    </block>
                </value>
                <value name="HIGH">
                    <block type="math_number">
                        <title name="NUM">100</title>
                    </block>
                </value>
            </block>
            <block type="math_random_int">
                <value name="FROM">
                    <block type="math_number">
                        <title name="NUM">1</title>
                    </block>
                </value>
                <value name="TO">
                    <block type="math_number">
                        <title name="NUM">100</title>
                    </block>
                </value>
            </block>
            <block type="math_random_float"></block>
            <block type="math_modulo"></block>
        </category>
        <category name="Colour">
            <block type="colour_picker"></block>
            <block type="colour_rgb"></block>
        </category>
        <category name="Text">
            <block type="text"></block>
            <block type="agocontrol_email"></block>
            <block type="agocontrol_phoneNumber"></block>
            <block type="agocontrol_valueOptions"></block>
            <block type="text_join"></block>
            <block type="text_append">
                <value name="TEXT">
                    <block type="text"></block>
                </value>
            </block>
            <block type="text_length"></block>
            <block type="text_isEmpty"></block>
            <block type="text_changeCase"></block>
            <block type="text_trim"></block>
            <block type="text_format"></block>
        </category>
        <category name="List">
            <block type="lists_create_empty"></block>
            <block type="lists_create_with"></block>
            <block type="lists_repeat">
                <value name="NUM">
                    <block type="math_number">
                        <field name="NUM">5</field>
                    </block>
                </value>
            </block>
            <block type="lists_length"></block>
            <block type="lists_isEmpty"></block>
            <block type="lists_indexOf">
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_getIndex">
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_setIndex">
                <value name="LIST">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_getSublist">
                <value name="LIST">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
        </category>
        <category name="Datetime">
            <block type="datetime_timestamp"></block>
            <block type="datetime_totimestamp"></block>
            <block type="datetime_currentdate"></block>
            <block type="datetime_specificdate"></block>
        </category>
        <category name="Common">
            <block type="text_print"></block>
            <block type="common_tonumber"></block>
            <block type="common_tostring"></block>
            <block type="common_type"></block>
            <block type="common_execute"></block>
        </category>
        <category name="Variables" custom="VARIABLE">
        </category>
        <category name="Procedures" custom="PROCEDURE">
        </category>
        <category name="Agocontrol">
            <category name="Content">
                <block type="agocontrol_content">
                    <value name="EVENT">
                        <block type="agocontrol_eventAll">
                        </block>
                    </value>
                </block>
                <block type="agocontrol_contentProperty"></block>
            </category>
            <category name="Inventory">
                <block type="agocontrol_deviceProperty"></block>
            </category>
            <category name="Device">
                <block type="agocontrol_deviceUuid"></block>
                <block type="agocontrol_deviceName"></block>
            </category>
            <category name="Event">
                <block type="agocontrol_deviceEvent"></block>
                <block type="agocontrol_eventAll"></block>
            </category>
            <category name="Actions">
                <block type="agocontrol_sendMessage"></block>
                <block type="agocontrol_sleep"></block>
            </category>
            <category name="Variables">
                <block type="agocontrol_getVariable"></block>
                <block type="agocontrol_setVariable"></block>
            </category>
        </category>
    </xml>

    <div id="blocklyDiv" style="height: 600px; width: 960px;"></div>
    <button id="generate">generate lua</button>
    <button id="xml">build xml</button>
    <button id="load">load xml</button>
    <div id="lua" style="height:600px; width:960px;"></div>

  <script type="text/javascript">
    getUnconnectedBlock = function() {
        var blocks = Blockly.mainWorkspace.getAllBlocks();
        for (var i = 0, block; block = blocks[i]; i++)
        {
            var connections = block.getConnections_(true);
            for (var j = 0, conn; conn = connections[j]; j++)
            {
                if (!conn.sourceBlock_ || (conn.type == Blockly.INPUT_VALUE || conn.type == Blockly.OUTPUT_VALUE) && !conn.targetConnection)
                {
                    return block;
                }
            }
        }
        return null;
    };
    
    getBlockWithWarning = function()
    {
        var blocks = Blockly.mainWorkspace.getAllBlocks();
        for (var i = 0, block; block = blocks[i]; i++)
        {
            if (block.warning)
            {
                return block;
            }
        }
        return null;
    };
    
    blinkBlock = function(block)
    {
        for(var i=300; i<3000; i=i+300)
        {
            setTimeout(function() { block.select(); },i);
            setTimeout(function() { block.unselect(); },i+150);
        }
    };

    var variables = [
        {'day':1},
        {'hour':2},
        {'month':3},
        {'year':4},
        {'minute':5}
    ];
  
    var schema = YAML.load('http://192.168.1.1/schema.yaml');
    var deviceMap = YAML.load('http://192.168.1.1/deviceMap.yaml');
    //var variables = YAML.load('http://192.168.1.1/variables.yaml');
    console.log("schema:");
    console.log(schema);
    console.log("deviceMap:");
    console.log(deviceMap);
    console.log("variables:");
    console.log(variables);
    Blockly.inject(document.getElementById('blocklyDiv'),
        {path: './', toolbox: document.getElementById('toolbox')});
    BlocklyAgocontrol.init(schema, deviceMap, variables);
    var generate = document.getElementById("generate");
    var xml = document.getElementById("xml");
    var lua = document.getElementById("lua");
    var load = document.getElementById("load");
    xml.onclick = function() {
        console.log(Blockly.Xml.workspaceToDom(Blockly.mainWorkspace));
    };
    generate.onclick = function() {
    
        // Check for bad block configurations that make it unlikely that
        // the resulting code is correct.
        var badBlock = getUnconnectedBlock();
        if (badBlock)
        {
            warningText = 'This block is not properly connected to other blocks.';
        }
        else
        {
            badBlock = getBlockWithWarning();
            if (badBlock)
            {
                warningText = 'Please fix the warning on this block.';
            }
        }

        if (badBlock)
        {
            lua.innerHTML = '<span style="color:red;">'+warningText+'</span>';
            blinkBlock(badBlock);
            return;
        }
    
        var code = Blockly.Lua.workspaceToCode();
        lua.textContent = code;
    };
    load.onclick = function() {
        //var xml = "<xml><block type=\"controls_if\" id=\"30\" inline=\"false\" x=\"47\" y=\"58\"><value name=\"IF0\"><block type=\"agocontrol_content\" id=\"22\" inline=\"false\"><value name=\"EVENT\"><block type=\"agocontrol_eventAll\" id=\"23\"><field name=\"EVENT\">event.environment.timechanged</field></block></value></block></value><statement name=\"DO0\"><block type=\"variables_set\" id=\"102\" inline=\"true\"><field name=\"VAR\">item</field><value name=\"VALUE\"><block type=\"agocontrol_contentProperty\" id=\"43\"><field name=\"EVENT\">event.environment.timechanged</field><field name=\"PROP\">minute</field></block></value><next><block type=\"agocontrol_setVariable\" id=\"99\" inline=\"true\"><field name=\"VARIABLE\">isDaytime</field><value name=\"VALUE\"><block type=\"math_arithmetic\" id=\"127\" inline=\"true\"><field name=\"OP\">MULTIPLY</field><value name=\"A\"><block type=\"variables_get\" id=\"130\"><field name=\"VAR\">item</field></block></value><value name=\"B\"><block type=\"math_number\" id=\"150\"><field name=\"NUM\">60</field></block></value></block></value></block></next></block></statement></block></xml>";
        //var xml = "<xml><block type=\"controls_if\" id=\"7\" inline=\"false\" x=\"66\" y=\"21\"><value name=\"IF0\"><block type=\"agocontrol_content\" id=\"11\" inline=\"false\"><value name=\"EVENT\"><block type=\"agocontrol_eventAll\" id=\"12\"><field name=\"EVENT\">event.device.statechanged</field></block></value></block></value><statement name=\"DO0\"><block type=\"text_print\" id=\"20\" inline=\"false\"><value name=\"TEXT\"><block type=\"agocontrol_deviceName\" id=\"26\" inline=\"true\"><value name=\"UUID\"><block type=\"agocontrol_contentProperty\" id=\"32\"><field name=\"EVENT\">event.device.statechanged</field><field name=\"PROP\">uuid</field></block></value></block></value></block></statement></block></xml>";
        console.log(xml);
        Blockly.Xml.domToWorkspace(xml);
    };
  </script>

</body>
</html>
